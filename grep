CommandLineParser.py
ConfigParser.py
HelpString.py
HtmlWriter.py
SaveLoad.py
VstupitP.py
WikiGetter.py
# Вступительная работа в параллель P.
# CommandLineParser.py
# Модуль, предназначенный для парсинга аргументов командной строки.

import sys

# ========================================================================================
# parse - парсит аргументы командной строки и записывает их в структуру config.
def parse(config) :
    i = 1
    while i < len(sys.argv) :
        param = sys.argv[i]
        if len(param) >= 2 and param[0:2] == "--" :
            if param == "--help" :         # Показать справку
                config.showHelp = True
            elif param == "--restart" :    # Начать делать запросы заново, не с сохранённого места
                config.restart = True
            elif param == "--no-saving" :  # При прерывании обработки списка прекратить работу, а не сохранять её
                config.noSaving = True
            elif param == "--saved-data" : # Имя файла для сохранённых данных
                if i == len(sys.argv) - 1 :
                    print("Ошибка: не указано имя файла для сохранённых данных")
                    exit(1)
                i += 1
                config.savedDataFile = sys.argv[i]
            elif param == "--config" : # Имя файла конфигурации
                if i == len(sys.argv) - 1 :
                    print("Ошибка: не указано имя файла конфигурации")
                    exit(1)
                i += 1
                config.configFile = sys.argv[i]
            else :
                print("Ошибка: неизвестный параметр", param, file = sys.stderr)
                exit(1)
        elif len(param) >= 2 and param[0] == "-" : # Парсинг однобуквенных ключей
            for c in param[1:] :
                if c == "h" :
                    config.showHelp = True
                elif c == "r" :
                    config.restart = True
                elif c == "n" :
                    config.noSaving = True
                else :
                    print("Ошибка: неизвестный ключ -" + c, file = sys.stderr)
                    exit(1)
        else :
            print("Ошибка: неизвестный параметр", param, file = sys.stderr)
            exit(1)
        i += 1

; Вступительная работа в параллель P.
; config.ini
; Файл настроек.

[DEFAULT]
; Адрес сайта (с протоколом)
siteUrl = http://oc.wikipedia.org
; Выходной файл
outputFile = output.html
; Заголовок страницы
pageTitle = Статьи Википедии с наибольшим количеством внешних ссылок
; Количество статей для вывода
pagesCount = 200
# Вступительная работа в параллель P.
# ConfigParser.py
# Модуль, предназначенный для парсинга файла конфигурации.

import configparser
import sys


# ========================================================================================
# getParamStr - возвращает значение параметра из файла конфигурации.
# Завершает программу с ошибкой при его отсутствии.
def getParamStr(configFile, param) :
    if param not in configFile['DEFAULT'] :
        print('Ошибка: в файле конфигурации отсутствует параметр', param, file = sys.stderr)
        exit(1)
    return configFile['DEFAULT'][param]


# ========================================================================================
# getParamInt - возвращает значение параметра из файла конфигурации, преобразованное к числовому типу.
# Завершает программу с ошибкой при его отсутствии или неверном формате.
def getParamInt(configFile, param) :
    try :
        a = int(getParamStr(configFile, param))
        if a <= 0 :
            raise ValueError
        return a
    except ValueError :
        print('Ошибка: некорректное значение', param, file = sys.stderr)
        exit(1)


# ========================================================================================
# parse - открывает файл fileName и считывает из него параметры.
def parse(config) :
    print('Парсинг файла', config.configFile, file = sys.stderr)
    configFile = configparser.ConfigParser()
    configFile.read(config.configFile)

    config.siteUrl = getParamStr(configFile, 'siteUrl')
    config.outputFile = getParamStr(configFile, 'outputFile')
    config.pageTitle = getParamStr(configFile, 'pageTitle')
    config.pagesCount = getParamInt(configFile, 'pagesCount')

    config.startEUOffset = 0
    config.startIdToPage = {}
# Вступительная работа в параллель P.
# HelpString.py
# Файл, содержащий строку справки для вывода на экран

helpString = """Вступительная работа в параллель P ЛКШ 2015.
Путилин Михаил, Новосибирск, 10 класс.
Программа, создающая таблицу статей Википедии с наибольшим количеством
внешних ссылок.
Если процесс обработки списка ссылок прервать (Ctrl-C),
данные будут записаны в файл и загружены при следующем запуске.

Использование: ./VstupitP.py [--help] [--restart] [--no-saving]
[--saved-data filename] [--config filename]
  -h, --help         показать эту справку.
  -r, --restart      не загружать ранее сохранённые данные (если они есть),
                     а начать с начала.
  -n, --no-saving    если процесс обработки списка ссылок будет прерван,
                     данные не будут сохранены, таблица будет создана сразу же.
  --saved-data       файл для сохранённых данных (по умолчанию - savedData.xml).
  --config           файл конфигурации (по умолчанию - config.ini).

В файле конфигурации содержатся данные для запуска программы:
  siteUrl      Адрес сайта (с протоколом)
  outputFile   Выходной файл
  pageTitle    Заголовок страницы
  pagesCount   Количество статей для вывода
Параметры из файла конфигурации не берутся, если загружаются ранее сохранённые данные."""
# Вступительная работа в параллель P.
# HtmlWriter.py
# Модуль, предназначенный для создания веб-страницы с таблицей статей.

import sys

# ========================================================================================
# Верхняя часть страницы
htmlPageTop = """\
<title>{pageTitle}</title>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
</head>
<body>
<table border="1" cellpadding="2" cols="3">
    <tr>
        <td bgcolor="ffffaa"><b>#</b></td>
        <td bgcolor="ffffaa" width="700"><b>Статья</b></td>
        <td bgcolor="ffffaa"><b>Количество<br>ссылок</b></td>
    </tr>\
"""
# Строка таблицы
htmlPageRow = """
    <tr>
        <td>{index:d}</td>
        <td><a href="{siteUrl}/wiki/{pageName}">{pageName}</a></td>
        <td>{extLinksCount:d}</td>
    </tr>"""
# Нижняя часть страницы
htmlPageBottom = """
</table>
</body>
"""

# ========================================================================================
# createPage - функция, создающая страницу с таблицей статей.
def createPage(config, pages) :
    # Открытие файла
    print('Создание страницы', config.outputFile, file = sys.stderr)
    try :
        htmlPage = open(config.outputFile, 'w')
    except OSError :
        print('Ошибка: не удалось создать файл', config.outputFile, file = sys.stderr)
        exit(1)

    # Создание таблицы
    htmlPage.write(htmlPageTop.format(pageTitle = config.pageTitle))
    for i in range(len(pages)) :
        page = pages[i]
        htmlPage.write(htmlPageRow.format(index = i + 1,
                                          siteUrl = config.siteUrl,
                                          pageName = page.name,
                                          extLinksCount = page.extLinksCount))
    htmlPage.write(htmlPageBottom)

    # Конец
    htmlPage.close()
    print('Страница успешно создана', file = sys.stderr)
<title>Статьи Википедии с наибольшим количеством внешних ссылок</title>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
</head>
<body>
<table border="1" cellpadding="2" cols="3">
    <tr>
        <td bgcolor="ffffaa"><b>#</b></td>
        <td bgcolor="ffffaa" width="700"><b>Статья</b></td>
        <td bgcolor="ffffaa"><b>Количество<br>ссылок</b></td>
    </tr>
    <tr>
        <td>1</td>
        <td><a href="http://en.wikipedia.org/wiki/December 2004 in sports">December 2004 in sports</a></td>
        <td>265</td>
    </tr>
    <tr>
        <td>2</td>
        <td><a href="http://en.wikipedia.org/wiki/January 2006 in Malaysia and Singapore">January 2006 in Malaysia and Singapore</a></td>
        <td>80</td>
    </tr>
    <tr>
        <td>3</td>
        <td><a href="http://en.wikipedia.org/wiki/Reactions to the 2005 French riots">Reactions to the 2005 French riots</a></td>
        <td>41</td>
    </tr>
    <tr>
        <td>4</td>
        <td><a href="http://en.wikipedia.org/wiki/January 2006 in science">January 2006 in science</a></td>
        <td>36</td>
    </tr>
    <tr>
        <td>5</td>
        <td><a href="http://en.wikipedia.org/wiki/Monetary influence of Jack Abramoff">Monetary influence of Jack Abramoff</a></td>
        <td>33</td>
    </tr>
    <tr>
        <td>6</td>
        <td><a href="http://en.wikipedia.org/wiki/January 2006 in sports">January 2006 in sports</a></td>
        <td>32</td>
    </tr>
    <tr>
        <td>7</td>
        <td><a href="http://en.wikipedia.org/wiki/Liberal Democrats leadership election, 2006">Liberal Democrats leadership election, 2006</a></td>
        <td>28</td>
    </tr>
    <tr>
        <td>8</td>
        <td><a href="http://en.wikipedia.org/wiki/Timeline of the Canadian federal election, 2006">Timeline of the Canadian federal election, 2006</a></td>
        <td>28</td>
    </tr>
    <tr>
        <td>9</td>
        <td><a href="http://en.wikipedia.org/wiki/First Macedonian War">First Macedonian War</a></td>
        <td>25</td>
    </tr>
    <tr>
        <td>10</td>
        <td><a href="http://en.wikipedia.org/wiki/Competition regulator">Competition regulator</a></td>
        <td>19</td>
    </tr>
    <tr>
        <td>11</td>
        <td><a href="http://en.wikipedia.org/wiki/List of IMAX venues">List of IMAX venues</a></td>
        <td>18</td>
    </tr>
    <tr>
        <td>12</td>
        <td><a href="http://en.wikipedia.org/wiki/List of high schools in Japan">List of high schools in Japan</a></td>
        <td>18</td>
    </tr>
    <tr>
        <td>13</td>
        <td><a href="http://en.wikipedia.org/wiki/Planetary habitability">Planetary habitability</a></td>
        <td>17</td>
    </tr>
    <tr>
        <td>14</td>
        <td><a href="http://en.wikipedia.org/wiki/Law 3037/2002">Law 3037/2002</a></td>
        <td>17</td>
    </tr>
    <tr>
        <td>15</td>
        <td><a href="http://en.wikipedia.org/wiki/Ukbara">Ukbara</a></td>
        <td>15</td>
    </tr>
    <tr>
        <td>16</td>
        <td><a href="http://en.wikipedia.org/wiki/Tengwar">Tengwar</a></td>
        <td>15</td>
    </tr>
    <tr>
        <td>17</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of West Virginia">Music of West Virginia</a></td>
        <td>14</td>
    </tr>
    <tr>
        <td>18</td>
        <td><a href="http://en.wikipedia.org/wiki/Streetcars in Washington, D.C.">Streetcars in Washington, D.C.</a></td>
        <td>14</td>
    </tr>
    <tr>
        <td>19</td>
        <td><a href="http://en.wikipedia.org/wiki/Civil engineering and infrastructure repair in New Orleans after Hurricane Katrina">Civil engineering and infrastructure repair in New Orleans after Hurricane Katrina</a></td>
        <td>13</td>
    </tr>
    <tr>
        <td>20</td>
        <td><a href="http://en.wikipedia.org/wiki/Rabbinic literature">Rabbinic literature</a></td>
        <td>13</td>
    </tr>
    <tr>
        <td>21</td>
        <td><a href="http://en.wikipedia.org/wiki/Operation Condor">Operation Condor</a></td>
        <td>13</td>
    </tr>
    <tr>
        <td>22</td>
        <td><a href="http://en.wikipedia.org/wiki/Mike Davis (scholar)">Mike Davis (scholar)</a></td>
        <td>12</td>
    </tr>
    <tr>
        <td>23</td>
        <td><a href="http://en.wikipedia.org/wiki/Huygens (spacecraft)">Huygens (spacecraft)</a></td>
        <td>12</td>
    </tr>
    <tr>
        <td>24</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of Philadelphia">Music of Philadelphia</a></td>
        <td>12</td>
    </tr>
    <tr>
        <td>25</td>
        <td><a href="http://en.wikipedia.org/wiki/United Self-Defense Forces of Colombia">United Self-Defense Forces of Colombia</a></td>
        <td>12</td>
    </tr>
    <tr>
        <td>26</td>
        <td><a href="http://en.wikipedia.org/wiki/List of Japanese artists">List of Japanese artists</a></td>
        <td>12</td>
    </tr>
    <tr>
        <td>27</td>
        <td><a href="http://en.wikipedia.org/wiki/Tom Bauer">Tom Bauer</a></td>
        <td>11</td>
    </tr>
    <tr>
        <td>28</td>
        <td><a href="http://en.wikipedia.org/wiki/Cecilia Tan">Cecilia Tan</a></td>
        <td>11</td>
    </tr>
    <tr>
        <td>29</td>
        <td><a href="http://en.wikipedia.org/wiki/Jack Abramoff Indian lobbying scandal">Jack Abramoff Indian lobbying scandal</a></td>
        <td>11</td>
    </tr>
    <tr>
        <td>30</td>
        <td><a href="http://en.wikipedia.org/wiki/Cistaceae">Cistaceae</a></td>
        <td>10</td>
    </tr>
    <tr>
        <td>31</td>
        <td><a href="http://en.wikipedia.org/wiki/Stock car (rail)">Stock car (rail)</a></td>
        <td>10</td>
    </tr>
    <tr>
        <td>32</td>
        <td><a href="http://en.wikipedia.org/wiki/Superbrands">Superbrands</a></td>
        <td>10</td>
    </tr>
    <tr>
        <td>33</td>
        <td><a href="http://en.wikipedia.org/wiki/European Exchange Rate Mechanism">European Exchange Rate Mechanism</a></td>
        <td>10</td>
    </tr>
    <tr>
        <td>34</td>
        <td><a href="http://en.wikipedia.org/wiki/Lu Yuegang">Lu Yuegang</a></td>
        <td>10</td>
    </tr>
    <tr>
        <td>35</td>
        <td><a href="http://en.wikipedia.org/wiki/John B. Cobb">John B. Cobb</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>36</td>
        <td><a href="http://en.wikipedia.org/wiki/Albert Allen Bartlett">Albert Allen Bartlett</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>37</td>
        <td><a href="http://en.wikipedia.org/wiki/Religion in Birmingham">Religion in Birmingham</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>38</td>
        <td><a href="http://en.wikipedia.org/wiki/WCQS">WCQS</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>39</td>
        <td><a href="http://en.wikipedia.org/wiki/Bring New Orleans Back Commission">Bring New Orleans Back Commission</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>40</td>
        <td><a href="http://en.wikipedia.org/wiki/Damadola airstrike">Damadola airstrike</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>41</td>
        <td><a href="http://en.wikipedia.org/wiki/Bahá'í administration">Bahá'í administration</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>42</td>
        <td><a href="http://en.wikipedia.org/wiki/Caxias do Sul">Caxias do Sul</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>43</td>
        <td><a href="http://en.wikipedia.org/wiki/United States Senate election in West Virginia, 2006">United States Senate election in West Virginia, 2006</a></td>
        <td>9</td>
    </tr>
    <tr>
        <td>44</td>
        <td><a href="http://en.wikipedia.org/wiki/Christian Democrats (Sweden)">Christian Democrats (Sweden)</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>45</td>
        <td><a href="http://en.wikipedia.org/wiki/Monica Maughan">Monica Maughan</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>46</td>
        <td><a href="http://en.wikipedia.org/wiki/2003 Santa Fe flood">2003 Santa Fe flood</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>47</td>
        <td><a href="http://en.wikipedia.org/wiki/Military history of Mexico">Military history of Mexico</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>48</td>
        <td><a href="http://en.wikipedia.org/wiki/Nick Herbert">Nick Herbert</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>49</td>
        <td><a href="http://en.wikipedia.org/wiki/Phonodeik">Phonodeik</a></td>
        <td>8</td>
    </tr>
    <tr>
        <td>50</td>
        <td><a href="http://en.wikipedia.org/wiki/Scott Ritter">Scott Ritter</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>51</td>
        <td><a href="http://en.wikipedia.org/wiki/English-language vowel changes before historic /r/">English-language vowel changes before historic /r/</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>52</td>
        <td><a href="http://en.wikipedia.org/wiki/Canadian federal election, 2004">Canadian federal election, 2004</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>53</td>
        <td><a href="http://en.wikipedia.org/wiki/Koreshanity">Koreshanity</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>54</td>
        <td><a href="http://en.wikipedia.org/wiki/Graeme Garden">Graeme Garden</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>55</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of California">Music of California</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>56</td>
        <td><a href="http://en.wikipedia.org/wiki/Leavenworth County, Kansas">Leavenworth County, Kansas</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>57</td>
        <td><a href="http://en.wikipedia.org/wiki/City Island, Bronx">City Island, Bronx</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>58</td>
        <td><a href="http://en.wikipedia.org/wiki/Gender neutrality in English">Gender neutrality in English</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>59</td>
        <td><a href="http://en.wikipedia.org/wiki/J. J. Pickle Research Campus">J. J. Pickle Research Campus</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>60</td>
        <td><a href="http://en.wikipedia.org/wiki/List of fictional computers">List of fictional computers</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>61</td>
        <td><a href="http://en.wikipedia.org/wiki/Tobias Bernstrup">Tobias Bernstrup</a></td>
        <td>7</td>
    </tr>
    <tr>
        <td>62</td>
        <td><a href="http://en.wikipedia.org/wiki/Outdoor sculpture in New York City">Outdoor sculpture in New York City</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>63</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of Texas">Music of Texas</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>64</td>
        <td><a href="http://en.wikipedia.org/wiki/Mechanical floor">Mechanical floor</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>65</td>
        <td><a href="http://en.wikipedia.org/wiki/GB 18030">GB 18030</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>66</td>
        <td><a href="http://en.wikipedia.org/wiki/Mu of Balhae">Mu of Balhae</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>67</td>
        <td><a href="http://en.wikipedia.org/wiki/William H. Calvin">William H. Calvin</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>68</td>
        <td><a href="http://en.wikipedia.org/wiki/Technical University of Lisbon">Technical University of Lisbon</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>69</td>
        <td><a href="http://en.wikipedia.org/wiki/Demographic history of Bosnia and Herzegovina">Demographic history of Bosnia and Herzegovina</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>70</td>
        <td><a href="http://en.wikipedia.org/wiki/Bowdoin College">Bowdoin College</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>71</td>
        <td><a href="http://en.wikipedia.org/wiki/Liang Qichao">Liang Qichao</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>72</td>
        <td><a href="http://en.wikipedia.org/wiki/Alfred J. Gross">Alfred J. Gross</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>73</td>
        <td><a href="http://en.wikipedia.org/wiki/Library 2.0">Library 2.0</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>74</td>
        <td><a href="http://en.wikipedia.org/wiki/Martin Newell (musician)">Martin Newell (musician)</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>75</td>
        <td><a href="http://en.wikipedia.org/wiki/Pittsburgh Tribune-Review">Pittsburgh Tribune-Review</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>76</td>
        <td><a href="http://en.wikipedia.org/wiki/For Real">For Real</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>77</td>
        <td><a href="http://en.wikipedia.org/wiki/Reading Terminal">Reading Terminal</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>78</td>
        <td><a href="http://en.wikipedia.org/wiki/The Atlantics">The Atlantics</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>79</td>
        <td><a href="http://en.wikipedia.org/wiki/Topic Maps">Topic Maps</a></td>
        <td>6</td>
    </tr>
    <tr>
        <td>80</td>
        <td><a href="http://en.wikipedia.org/wiki/Jonathan Franzen">Jonathan Franzen</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>81</td>
        <td><a href="http://en.wikipedia.org/wiki/Mickey Finn (comic strip)">Mickey Finn (comic strip)</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>82</td>
        <td><a href="http://en.wikipedia.org/wiki/First Texas Legislature">First Texas Legislature</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>83</td>
        <td><a href="http://en.wikipedia.org/wiki/Upstate South Carolina">Upstate South Carolina</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>84</td>
        <td><a href="http://en.wikipedia.org/wiki/VGMusic.com">VGMusic.com</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>85</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XXXVII">Super Bowl XXXVII</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>86</td>
        <td><a href="http://en.wikipedia.org/wiki/Langley Research Center">Langley Research Center</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>87</td>
        <td><a href="http://en.wikipedia.org/wiki/Aliso Viejo, California">Aliso Viejo, California</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>88</td>
        <td><a href="http://en.wikipedia.org/wiki/Brian Nichols">Brian Nichols</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>89</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of Connecticut">Music of Connecticut</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>90</td>
        <td><a href="http://en.wikipedia.org/wiki/LGBT history in Singapore">LGBT history in Singapore</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>91</td>
        <td><a href="http://en.wikipedia.org/wiki/Exergy">Exergy</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>92</td>
        <td><a href="http://en.wikipedia.org/wiki/Administrative divisions of Portugal">Administrative divisions of Portugal</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>93</td>
        <td><a href="http://en.wikipedia.org/wiki/3-Quinuclidinyl benzilate">3-Quinuclidinyl benzilate</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>94</td>
        <td><a href="http://en.wikipedia.org/wiki/Rosalind E. Krauss">Rosalind E. Krauss</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>95</td>
        <td><a href="http://en.wikipedia.org/wiki/Triratna Buddhist Community">Triratna Buddhist Community</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>96</td>
        <td><a href="http://en.wikipedia.org/wiki/PETSCII">PETSCII</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>97</td>
        <td><a href="http://en.wikipedia.org/wiki/Ernie Hart">Ernie Hart</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>98</td>
        <td><a href="http://en.wikipedia.org/wiki/Lindsay Gaze">Lindsay Gaze</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>99</td>
        <td><a href="http://en.wikipedia.org/wiki/Biophoton">Biophoton</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>100</td>
        <td><a href="http://en.wikipedia.org/wiki/Helen Pitts Douglass">Helen Pitts Douglass</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>101</td>
        <td><a href="http://en.wikipedia.org/wiki/Synopsys">Synopsys</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>102</td>
        <td><a href="http://en.wikipedia.org/wiki/Sinocentrism">Sinocentrism</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>103</td>
        <td><a href="http://en.wikipedia.org/wiki/Equol">Equol</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>104</td>
        <td><a href="http://en.wikipedia.org/wiki/Anthony Romero">Anthony Romero</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>105</td>
        <td><a href="http://en.wikipedia.org/wiki/Stanley (vehicle)">Stanley (vehicle)</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>106</td>
        <td><a href="http://en.wikipedia.org/wiki/Dextro-Transposition of the great arteries">Dextro-Transposition of the great arteries</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>107</td>
        <td><a href="http://en.wikipedia.org/wiki/Gordon Chater">Gordon Chater</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>108</td>
        <td><a href="http://en.wikipedia.org/wiki/Security Practices and Research Student Association">Security Practices and Research Student Association</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>109</td>
        <td><a href="http://en.wikipedia.org/wiki/Carbonatite">Carbonatite</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>110</td>
        <td><a href="http://en.wikipedia.org/wiki/John Tartaglione">John Tartaglione</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>111</td>
        <td><a href="http://en.wikipedia.org/wiki/Blinman">Blinman</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>112</td>
        <td><a href="http://en.wikipedia.org/wiki/Lagniappe">Lagniappe</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>113</td>
        <td><a href="http://en.wikipedia.org/wiki/Michael Fumento">Michael Fumento</a></td>
        <td>5</td>
    </tr>
    <tr>
        <td>114</td>
        <td><a href="http://en.wikipedia.org/wiki/Anna-Maria Papaharalambous">Anna-Maria Papaharalambous</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>115</td>
        <td><a href="http://en.wikipedia.org/wiki/London Tecumsehs">London Tecumsehs</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>116</td>
        <td><a href="http://en.wikipedia.org/wiki/David Drake">David Drake</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>117</td>
        <td><a href="http://en.wikipedia.org/wiki/Conscription in Taiwan">Conscription in Taiwan</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>118</td>
        <td><a href="http://en.wikipedia.org/wiki/William E. Barber">William E. Barber</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>119</td>
        <td><a href="http://en.wikipedia.org/wiki/Dane Rudhyar">Dane Rudhyar</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>120</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XIV">Super Bowl XIV</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>121</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XVI">Super Bowl XVI</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>122</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XIX">Super Bowl XIX</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>123</td>
        <td><a href="http://en.wikipedia.org/wiki/Josef Clemens">Josef Clemens</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>124</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XXXIV">Super Bowl XXXIV</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>125</td>
        <td><a href="http://en.wikipedia.org/wiki/Martin Crewes">Martin Crewes</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>126</td>
        <td><a href="http://en.wikipedia.org/wiki/Seminal Live">Seminal Live</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>127</td>
        <td><a href="http://en.wikipedia.org/wiki/CISA-DT">CISA-DT</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>128</td>
        <td><a href="http://en.wikipedia.org/wiki/Luton Airport">Luton Airport</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>129</td>
        <td><a href="http://en.wikipedia.org/wiki/Music of Idaho">Music of Idaho</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>130</td>
        <td><a href="http://en.wikipedia.org/wiki/Death of Jeremiah Duggan">Death of Jeremiah Duggan</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>131</td>
        <td><a href="http://en.wikipedia.org/wiki/List of musicians from Quebec">List of musicians from Quebec</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>132</td>
        <td><a href="http://en.wikipedia.org/wiki/Techniscope">Techniscope</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>133</td>
        <td><a href="http://en.wikipedia.org/wiki/AtariWriter">AtariWriter</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>134</td>
        <td><a href="http://en.wikipedia.org/wiki/L. Heisler Ball">L. Heisler Ball</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>135</td>
        <td><a href="http://en.wikipedia.org/wiki/Hanoch Levin">Hanoch Levin</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>136</td>
        <td><a href="http://en.wikipedia.org/wiki/Sutro Tower">Sutro Tower</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>137</td>
        <td><a href="http://en.wikipedia.org/wiki/Marios Matsakis">Marios Matsakis</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>138</td>
        <td><a href="http://en.wikipedia.org/wiki/WZME">WZME</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>139</td>
        <td><a href="http://en.wikipedia.org/wiki/Cucurbitales">Cucurbitales</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>140</td>
        <td><a href="http://en.wikipedia.org/wiki/Telecommunications in Nigeria">Telecommunications in Nigeria</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>141</td>
        <td><a href="http://en.wikipedia.org/wiki/Guitar Wolf">Guitar Wolf</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>142</td>
        <td><a href="http://en.wikipedia.org/wiki/Louise M. Davies Symphony Hall">Louise M. Davies Symphony Hall</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>143</td>
        <td><a href="http://en.wikipedia.org/wiki/Chanter Sisters">Chanter Sisters</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>144</td>
        <td><a href="http://en.wikipedia.org/wiki/Huang Yuanyong">Huang Yuanyong</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>145</td>
        <td><a href="http://en.wikipedia.org/wiki/London Majors">London Majors</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>146</td>
        <td><a href="http://en.wikipedia.org/wiki/Jackson Morton">Jackson Morton</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>147</td>
        <td><a href="http://en.wikipedia.org/wiki/Esperanto orthography">Esperanto orthography</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>148</td>
        <td><a href="http://en.wikipedia.org/wiki/POETICS list">POETICS list</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>149</td>
        <td><a href="http://en.wikipedia.org/wiki/TKKG">TKKG</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>150</td>
        <td><a href="http://en.wikipedia.org/wiki/Fernão Mendes Pinto">Fernão Mendes Pinto</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>151</td>
        <td><a href="http://en.wikipedia.org/wiki/Churchill (electoral district)">Churchill (electoral district)</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>152</td>
        <td><a href="http://en.wikipedia.org/wiki/CKLW">CKLW</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>153</td>
        <td><a href="http://en.wikipedia.org/wiki/Wattle Grove, New South Wales">Wattle Grove, New South Wales</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>154</td>
        <td><a href="http://en.wikipedia.org/wiki/Asteroid impact avoidance">Asteroid impact avoidance</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>155</td>
        <td><a href="http://en.wikipedia.org/wiki/Xiao Qian">Xiao Qian</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>156</td>
        <td><a href="http://en.wikipedia.org/wiki/Birkenes">Birkenes</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>157</td>
        <td><a href="http://en.wikipedia.org/wiki/Goli Ameri">Goli Ameri</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>158</td>
        <td><a href="http://en.wikipedia.org/wiki/2006 in baseball">2006 in baseball</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>159</td>
        <td><a href="http://en.wikipedia.org/wiki/Bristol County, Massachusetts">Bristol County, Massachusetts</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>160</td>
        <td><a href="http://en.wikipedia.org/wiki/East Windsor Township, New Jersey">East Windsor Township, New Jersey</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>161</td>
        <td><a href="http://en.wikipedia.org/wiki/Ludington Light">Ludington Light</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>162</td>
        <td><a href="http://en.wikipedia.org/wiki/Karunaratne Abeysekera">Karunaratne Abeysekera</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>163</td>
        <td><a href="http://en.wikipedia.org/wiki/List of acronyms: M">List of acronyms: M</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>164</td>
        <td><a href="http://en.wikipedia.org/wiki/Samuel Whiteside">Samuel Whiteside</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>165</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl VIII">Super Bowl VIII</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>166</td>
        <td><a href="http://en.wikipedia.org/wiki/Tolkien fandom">Tolkien fandom</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>167</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XIII">Super Bowl XIII</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>168</td>
        <td><a href="http://en.wikipedia.org/wiki/Cinema of Korea">Cinema of Korea</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>169</td>
        <td><a href="http://en.wikipedia.org/wiki/Dar al-Manasir">Dar al-Manasir</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>170</td>
        <td><a href="http://en.wikipedia.org/wiki/James Fontaine">James Fontaine</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>171</td>
        <td><a href="http://en.wikipedia.org/wiki/The Eyes of Texas">The Eyes of Texas</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>172</td>
        <td><a href="http://en.wikipedia.org/wiki/W0KIE">W0KIE</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>173</td>
        <td><a href="http://en.wikipedia.org/wiki/Don L. Lind">Don L. Lind</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>174</td>
        <td><a href="http://en.wikipedia.org/wiki/Schwetzingen">Schwetzingen</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>175</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XII">Super Bowl XII</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>176</td>
        <td><a href="http://en.wikipedia.org/wiki/Perseverance of the saints">Perseverance of the saints</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>177</td>
        <td><a href="http://en.wikipedia.org/wiki/Jefferson Park (Seattle)">Jefferson Park (Seattle)</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>178</td>
        <td><a href="http://en.wikipedia.org/wiki/Theophoric name">Theophoric name</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>179</td>
        <td><a href="http://en.wikipedia.org/wiki/Saskatoon—Rosetown—Biggar">Saskatoon—Rosetown—Biggar</a></td>
        <td>4</td>
    </tr>
    <tr>
        <td>180</td>
        <td><a href="http://en.wikipedia.org/wiki/Allotment (gardening)">Allotment (gardening)</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>181</td>
        <td><a href="http://en.wikipedia.org/wiki/Orleans Primary School">Orleans Primary School</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>182</td>
        <td><a href="http://en.wikipedia.org/wiki/Victor Niederhoffer">Victor Niederhoffer</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>183</td>
        <td><a href="http://en.wikipedia.org/wiki/Henry Giroux">Henry Giroux</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>184</td>
        <td><a href="http://en.wikipedia.org/wiki/Deaths in January 2005">Deaths in January 2005</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>185</td>
        <td><a href="http://en.wikipedia.org/wiki/Watts Towers">Watts Towers</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>186</td>
        <td><a href="http://en.wikipedia.org/wiki/Mark Mothersbaugh">Mark Mothersbaugh</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>187</td>
        <td><a href="http://en.wikipedia.org/wiki/Coupling (UK TV series)">Coupling (UK TV series)</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>188</td>
        <td><a href="http://en.wikipedia.org/wiki/Lisa Rinna">Lisa Rinna</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>189</td>
        <td><a href="http://en.wikipedia.org/wiki/Terry Winograd">Terry Winograd</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>190</td>
        <td><a href="http://en.wikipedia.org/wiki/Julie Buck">Julie Buck</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>191</td>
        <td><a href="http://en.wikipedia.org/wiki/Bob Toski">Bob Toski</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>192</td>
        <td><a href="http://en.wikipedia.org/wiki/Wagyl">Wagyl</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>193</td>
        <td><a href="http://en.wikipedia.org/wiki/Hungarian forint">Hungarian forint</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>194</td>
        <td><a href="http://en.wikipedia.org/wiki/Cypherpunk">Cypherpunk</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>195</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl VII">Super Bowl VII</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>196</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XI">Super Bowl XI</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>197</td>
        <td><a href="http://en.wikipedia.org/wiki/USS Huron (PF-19)">USS Huron (PF-19)</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>198</td>
        <td><a href="http://en.wikipedia.org/wiki/Super Bowl XVIII">Super Bowl XVIII</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>199</td>
        <td><a href="http://en.wikipedia.org/wiki/Dr. Strangelove">Dr. Strangelove</a></td>
        <td>3</td>
    </tr>
    <tr>
        <td>200</td>
        <td><a href="http://en.wikipedia.org/wiki/Udaff">Udaff</a></td>
        <td>3</td>
    </tr>
</table>
</body>
## Вступительная работа в параллель P ЛКШ 2015
Путилин Михаил, Новосибирск, 10 класс.

Программа, создающая таблицу статей Википедии с наибольшим количеством
внешних ссылок.

Если процесс обработки списка ссылок прервать (Ctrl-C),
данные будут записаны в файл и загружены при следующем запуске.

### Использование:
_./VstupitP.py [--help] [--restart] [--no-saving] [--saved-data filename] [--config filename]_
* _-h, --help_ - показать справку.
* _-r, --restart_ - не загружать ранее сохранённые данные (если они есть), а начать с начала.
* _-n, --no-saving_ - если процесс обработки списка ссылок будет прерван, данные не будут сохранены, таблица будет создана сразу же.
* _--saved-data_ - файл для сохранённых данных (по умолчанию - _savedData.xml_).
* _--config_ - файл конфигурации (по умолчанию - _config.ini_).


В файле конфигурации содержатся данные для запуска программы:
* _siteUrl_ - Адрес сайта (с протоколом)
* _outputFile_ - Выходной файл
* _pageTitle_ - Заголовок страницы
* _pagesCount_ - Количество статей для вывода

Параметры из файла конфигурации не берутся, если загружаются ранее сохранённые данные.
# Вступительная работа в параллель P.
# SaveLoader.py
# Модуль, предназначенный для сохранения и загрузки
# промежуточных результатов выполнения программы

import sys
import os
from lxml import etree
from WikiGetter import Page

# ========================================================================================
# loadData - загрузить данные и записать их в config.as
# Возвращает True в случае успеха
def loadData(config) :
    print("Попытка загрузить ранее сохранённые данные", file = sys.stderr)
    try :
        xml = etree.parse(config.savedDataFile)
    except (OSError, etree.XMLSyntaxError) :
        print("Файл", config.savedDataFile, "не существует или повреждён", file = sys.stderr)
        return False

    # Получение основных параметров из файла
    try :
        xmlConfig = xml.xpath('/root/config')[0]
    except IndexError :
        print("Файл", config.savedDataFile, "не существует или повреждён", file = sys.stderr)
        return False

    config.siteUrl = xmlConfig.get("siteUrl")
    config.outputFile = xmlConfig.get("outputFile")
    config.pageTitle = xmlConfig.get("pageTitle")
    try :
        config.pagesCount = int(xmlConfig.get("pagesCount"))
        if config.pagesCount <= 0 :
            raise ValueError
    except ValueError :
        print("Файл", config.savedDataFile, "не существует или повреждён", file = sys.stderr)
        return False

    # Значение euoffset
    try :
        config.startEUOffset = int(xml.xpath("/root/euoffset")[0].get("value"))
    except (IndexError, ValueError) :
        print("Файл", config.savedDataFile, "не существует или повреждён", file = sys.stderr)
        return False

    # Страницы
    for item in xml.xpath("/root/pages/page") :
        try :
            page = Page()
            page.name = item.get("name")
            page.extLinksCount = int(item.get("extLinksCount"))
            config.startIdToPage[int(item.get("id"))] = page
        except ValueError :
            print("Файл", config.savedDataFile, "не существует или повреждён", file = sys.stderr)
            return False

    print("Данные загружены", file = sys.stderr)
    return True

# ========================================================================================
# saveData - сохраняет данные в файл
def saveData(config, idToPage, euoffset) :
    print("Сохранение данных на диск", file = sys.stderr)
    # Создание корневого элемента
    xmlRoot = etree.Element("root")
    # Конфигурация
    xmlConfig = etree.SubElement(xmlRoot, "config")
    xmlConfig.set("siteUrl", config.siteUrl)
    xmlConfig.set("outputFile", config.outputFile)
    xmlConfig.set("pageTitle", config.pageTitle)
    xmlConfig.set("pagesCount", str(config.pagesCount))
    # euoffset
    xmlEUOffset = etree.SubElement(xmlRoot, "euoffset")
    xmlEUOffset.set("value", str(euoffset))
    # Страницы
    xmlPages = etree.SubElement(xmlRoot, "pages")
    for page in idToPage.items() :
        xmlPage = etree.SubElement(xmlPages, "page")
        xmlPage.set("id", str(page[0]))
        xmlPage.set("name", page[1].name)
        xmlPage.set("extLinksCount", str(page[1].extLinksCount))

   # Запись в файл
    try :
        file = open(config.savedDataFile, 'wb')
    except OSError :
        print('Ошибка: не удалось создать файл', config.savedDataFile, file = sys.stderr)
        exit(1)
    file.write(etree.tostring(xmlRoot))
    file.close()

# ========================================================================================
# clearData - удаляет файл с сохранёнными данными.
def clearData(config) :
    try :
        os.remove(config.savedDataFile)
    except OSError :
        pass#!/usr/bin/python3
# Вступительная работа в параллель P.
# VstupitP.py
# Главный файл программы.

import sys
import threading

import CommandLineParser
import ConfigParser
import SaveLoad
import HelpString
import WikiGetter
import HtmlWriter

# ========================================================================================
# Config - структура, содержащая параметры запуска программы
class Config :
    # Параметры командной строки
    showHelp = False
    restart = False
    noSaving = False
    savedDataFile = "savedData.xml"
    configFile = "config.ini"

    # Параметры из файла config.ini
    siteUrl = ''
    outputFile = ''
    pageTitle = ''
    pagesCount = 0

    # Данные, сохранённые ранее в файл
    startEUOffset = 0
    startIdToPage = {}
config = Config()

# ========================================================================================
# Парсинг аргументов командной строки
CommandLineParser.parse(config)

# Вывод справки, если есть ключ --help
if config.showHelp :
    print(HelpString.helpString, file = sys.stderr)
    exit(0)

# Если не выставлен флаг --restart, считать файл с сохранёнными данными
if not config.restart :
    success = SaveLoad.loadData(config)
    # Если не удалось считать данные, начать с начала
    if not success :
        config.restart = True

# Парсинг файла конфигурации, если нужно начинать процесс с начала
if config.restart :
    ConfigParser.parse(config)

# Получение списка статей с внешними ссылками с помощью MetaWiki API
# Запуск отдельного поток; главный будет отлавливать KeyboardInterrupt
wikiGetterResult = WikiGetter.Result()
wikiGetterThread = threading.Thread(target = WikiGetter.getPagesWithExtLinks, args = (config, wikiGetterResult))
wikiGetterThread.start()
while True :
    try :
        wikiGetterThread.join()
        break
    except KeyboardInterrupt :
        WikiGetter.interrupt()

# Если всё готово или выставлен флаг --no-saving, создать страницу,
# иначе - записать в файл
if wikiGetterResult.done or config.noSaving :
    pages = WikiGetter.createList(wikiGetterResult.idToPage, config.pagesCount)
    HtmlWriter.createPage(config, pages)
    SaveLoad.clearData(config)
else :
    SaveLoad.saveData(config, wikiGetterResult.idToPage, wikiGetterResult.euoffset)
# Вступительная работа в параллель P.
# WikiGetter.py
# Модуль, предназначенный для получения нужной информации из Википедии.

import urllib.request
import sys
import heapq
from lxml import etree

EULIMIT = 500
LIST_PARSING_OUTPUT_PERIOD = 40


# ========================================================================================
# Page - структура, содежащая информацию о странице
class Page :
    name = ''
    extLinksCount = 0


# ========================================================================================
# parseExtUrlResponse - парсинг списка внешних ссылок и добавление в словарь.
# Возвращает новый euoffset (или -1, если это конец)
def parseExtUrlResponse(file, idToPage) :
    responseXml = etree.parse(file)

    # Получение нового значения euoffset
    xmlQueryContinue = responseXml.xpath('/api/query-continue/exturlusage')
    if len(xmlQueryContinue) == 0 :
        newOffset = -1
    else :
        newOffset = int(xmlQueryContinue[0].get('euoffset'))

    # Просмотр списка внешних ссылок
    xmlExtUrls = responseXml.xpath('/api/query/exturlusage/eu')
    for item in xmlExtUrls :
        pageId = int(item.get('pageid'))
        if pageId not in idToPage :
            # Создание объекта Page, если этой статьи ещё не было
            page = Page()
            page.name = item.get('title')
            page.extLinksCount = 1
            idToPage[pageId] = page
        else :
            # Увеличение счётчика ссылок статьи
            idToPage[pageId].extLinksCount += 1

    return newOffset


# ========================================================================================
# sortList - сортирует список статей по убыванию количества ссылок
# и оставляет pagesCount наибольших.
def createList(idToPage, pagesCount) :
    return heapq.nlargest(pagesCount, idToPage.values(), key = (lambda x : x.extLinksCount))

# ========================================================================================
# interrupt - функция, прерывающая выполнение getPagesWithExtLinks
# interrupted - было ли выполнение прервано
interrupted = False
def interrupt() :
    global interrupted
    interrupted = True

# ========================================================================================
# Result - в экземпляр этого класса записываются результаты выполнения функции
# getPagesWithExtLinks
class Result :
    idToPage = {}   # Страницы
    done = False    # True, если обработка списка завершена
    euoffset = 0    # Значение euoffset, если процесс не завершён

# ========================================================================================
# getPagesWithExtLinks - функция, записывающая в result список страниц
# с указанием количества внешних ссылок.
def getPagesWithExtLinks(config, result) :
    print('Получение информации с', config.siteUrl, file = sys.stderr)

    # Страницы
    idToPage = config.startIdToPage

    # URL запроса
    apiUrl = config.siteUrl + '/w/api.php'
    extUrlRequestUrl = apiUrl + '?'
    extUrlRequestUrl += 'action=query&'
    extUrlRequestUrl += 'list=exturlusage&'
    extUrlRequestUrl += 'format=xml&'
    extUrlRequestUrl += 'eunamespace=0&'
    extUrlRequestUrl += 'rawcontinue&'
    extUrlRequestUrl += 'eulimit={eulimit:d}&'
    extUrlRequestUrl += 'euoffset={euoffset:d}'

    euoffset = config.startEUOffset
    outputPeriodLeft = LIST_PARSING_OUTPUT_PERIOD

    if euoffset != 0 :
        print("Процесс продолжается, уже обработано", euoffset, "ссылок", file = sys.stderr)

    while True :
        # Запрос к MediaWiki API на получение данных
        try :
            response = urllib.request.urlopen(extUrlRequestUrl.format(eulimit = EULIMIT, euoffset = euoffset))
        except (urllib.error.URLError, ValueError) :
            print('Ошибка: не удалось получить доступ к', apiUrl, file = sys.stderr)
            result.euoffset = euoffset
            result.idToPage = idToPage
            result.done = False
            return

        # Парсинг xml
        euoffset = parseExtUrlResponse(response, idToPage)
        response.close()
        if euoffset == -1 :
            break

        # Каждые LIST_PARSING_OUTPUT_PERIOD итераций вывод в stderr количества обработанных ссылок
        outputPeriodLeft -= 1
        if outputPeriodLeft == 0 :
            outputPeriodLeft = LIST_PARSING_OUTPUT_PERIOD
            print('Обработано', euoffset, 'ссылок...', file = sys.stderr)

        # Если прервано, выйти из функции
        if interrupted :
            print("\nПроцесс обработки ссылок прерван пользователем", file = sys.stderr)
            result.idToPage = idToPage
            result.done = False
            result.euoffset = euoffset
            return

    result.idToPage = idToPage
    result.done = True
; Вступительная работа в параллель P.
; config.ini
; Файл настроек.

[DEFAULT]
; Адрес сайта (с протоколом)
siteUrl = http://oc.wikipedia.org
; Выходной файл
outputFile = output.html
; Заголовок страницы
pageTitle = Статьи Википедии с наибольшим количеством внешних ссылок
; Количество статей для вывода
pagesCount = 200
